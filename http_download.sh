http_download_curl() {
    local_file=$1
    source_url=$2
    header=$3
    if [ -z "$header" ]; then
        code=$(curl -w '%{http_code}' -sL -o "$local_file" "$source_url")
    else
        code=$(curl -w '%{http_code}' -sL -H "$header" -o "$local_file" "$source_url")
    fi
    if [ "$code" != "200" ]; then
        log_debug "http_download_curl received HTTP status $code"
        return 1
    fi
    return 0
}

# http_download_wget
#
# unable to get server response code in a portable manner
# busybox wget (used on alpine linux) does not support "--server-response"
#
http_download_wget() {
    local_file=$1
    source_url=$2
    header=$3
    if [ -z "$header" ]; then
        wget -q -O "$local_file" "$source_url"
    else
        wget -q --header "$header" -O "$local_file" "$source_url"
    fi
}

# http_download_aria2
#
# unable to get server response code in a portable manner
#
http_download_aria2() {
    local_file=$1
    source_url=$2
    header=$3
    local_file_dir=${local_file%/*}
    if [ -z "$header" ]; then
        aria2c -q -d "$local_file_dir" "$source_url"
    else
        aria2c -q --header "$header" -d "$local_file_dir" "$source_url"
    fi
}
#
# http_download [local-file] [url] [optional extra header]
#
# if arg3 is not empty it will add it as an extra HTTP header
# must be in the form "foo: bar"
#
http_download() {
    log_debug "http_download $2"
    if is_command curl; then
        http_download_curl "$@"
        return
    elif is_command wget; then
        http_download_wget "$@"
        return
    elif is_command aria2c; then
        http_download_aria2 "$@"
        return
    fi
    log_crit "http_download unable to find wget or curl"
    return 1
}

# http_copy - copies contents of a URL to stdout or fail
#
# needed since curl is broken
#
http_copy() {
    tmp=$(mktemp)
    http_download "${tmp}" "$1" "$2" || return 1
    body=$(cat "$tmp")
    rm -f "${tmp}"
    echo "$body"
}
